\chapter{Rigid Body Dynamics Simulation}

This chapter mainly introduces rigid body simulation to help you understand how computer simulate rigid dynamics based on traditional newton-euler equations. For more details, some contact forces solvers are decribed in this chapter. Afterwards, we will use one of solver to run some simulation and get the image data for the next step, grids-transfer. All the discussion about rigid simulation and contacts solver are based on 2-$D$ view.

\section{Rigid dynamics Simulation}

\subsection{Simulation Basics}

Simulating the motion of a rigid body is almost the same as simulating the motion of a particle, so I will start with partcle simulation. For particle simulation, we let function $\pmb{x}(t)$ describe the particle's location in world space at time $t$. Then we use $\pmb{v}(t)=\frac{\dif}{\dif(t)}\pmb{x}(t)$
to denote the velocity of the particle at time t. So, the state of a particle at a time t is the particle's position and velocity. We generalize this concept by defining a state vector $\textbf{Y}(t)$ for a system: for a single particle,
\begin{equation}
    \textbf{Y}(t) = \left(
        \begin{array}{c}
            \pmb{x}_{1}(t) \\
            \pmb{v}_{1}(t) \\
        \end{array}
    \right)
\end{equation}

For a system with $n$ particles, we enlarge $\textbf{Y}(t)$ to be
\begin{equation}
    \textbf{Y}(t) = \left(
    \begin{array}{c}
        \pmb{x}_{1}(t) \\
        \pmb{v}_{1}(t) \\
        ... \\
        \pmb{x}_{n}(t) \\
        \pmb{v}_{n}(t) \\
    \end{array}
    \right)
\end{equation}

However, to simulate the motion of particles actually, we need to know one more thing -- the forces. $\pmb{F}(t)$ is defined as the force acting on the particle. If the mass of the particle is $m$, then the changes of $\textbf{Y}(t)$ will be given by
\begin{equation}
    \frac{\dif}{\dif(t)}\textbf{Y}(t) = \frac{\dif}{\dif(t)}\left(
        \begin{array}{c}
            \pmb{x}(t) \\
            \pmb{v}(t) \\
        \end{array} \right) = \left(
        \begin{array}{c}
            \pmb{v}(t) \\
            \pmb{F}(t)/m \\
        \end{array} \right)
\end{equation}

\subsection{Rigid Body Concepts}
Unlike a particle, a rigid body occupies a volume of space and has a particular shape. Rigid bodies are more complicated, beside translating them, we can rotate them as well. To locate a rigid body, we use $\pmb{x}(t)$ to denote their translation and a rotation matrix $\pmb{R}(t)$ to describe their rotation.

\subsection{Rigid Body Equations of Motions}
 Whereas linear momentum $\pmb{P}(t)$ is related to linear velocity with a scalar (the mass), angular momentum is related to angular velocity with a matrix \(\pmb{I}\), called the angular inertia matrix. The reason for this is that objects generally have different angular inertias around different axes of rotation. Angular momentum is defined as \(\pmb{L}\). The linear momentum is defined as \ref{lm}, and angular momentum is defined as \ref{am}
\begin{equation}
    \pmb{P}(t) = m \pmb{v} (t)
    \label{lm}
\end{equation}

\begin{equation}
    \pmb{L}(t) = \pmb{I}(t)\pmb{\omega}(t)
    \label{am}
\end{equation}

The total torque $\pmb{\tau}$ applied to the body is equal to the rate of change of the angular momentum, as defined in \ref{tau}:
\begin{equation}
    \pmb{\tau} = \frac{\dif}{\dif t }\pmb{L} = \frac{\dif}{\dif t }(\pmb{I}\pmb{\omega})
    \label{tau}
\end{equation}

 Then we can covert all concepts we need to define stare $\textbf{Y}$ for a rigid body.

\begin{equation}
    \textbf{Y}(t) = \left(
        \begin{array}{c}
            \pmb{x}(t) \\
            \pmb{R}(t) \\
            \pmb{P}(t) \\
            \pmb{L}(t) \\
        \end{array}
    \right)
\end{equation}

Like what is epressed in $\textbf{Y}(t)$, the state of a rigid body is mainly consist by its position and orientation (describing spatial information), and its linear and angualr momentum(describe velocity information). Since mass $m$ and bodyspace inertia tensor $\pmb{I}_{body}$ are constants, we can the auxiliary quantities $\pmb{I}(t)$, $\pmb{\omega}(t)$ at any given time.

\begin{equation}
    \pmb{v}(t) = \frac{\pmb{P}(t)}{m} \quad
    \pmb{I}(t) = \pmb{R}(t)\pmb{I}_{body}\pmb{R}(t)^{T} \quad
    \pmb{\omega}(t) = \pmb{I}(t)^{-1}\pmb{L}(t)
\end{equation}

The derivative $\frac{\dif}{\dif t}\textbf{Y}(t)$ is
\begin{equation}
    \frac{\dif}{\dif{t}}\textbf{Y}(t) = \frac{\dif}{\dif t}\left(
        \begin{array}{c}
            \pmb{x}(t) \\
            \pmb{R}(t) \\
            m \pmb{v}(t) \\
            \pmb{L}(t) \\
        \end{array}
    \right) = \frac{\dif}{\dif t}\left(
        \begin{array}{c}
            \pmb{v}(t) \\
            \pmb{\omega}(t)\times\pmb{R}(t) \\
            \pmb{F}(t) \\
            \pmb{\tau}(t) \\
        \end{array}
    \right)
\end{equation}

Then, we can evaluate Equation \ref{tau_ev} as follows:
\begin{equation}
    \begin{aligned}
        \pmb{\tau} &= \frac{\dif}{\dif t}(\pmb{I}\pmb{\omega}) \\
        &= \pmb{I}\dot{\pmb{\omega}} + \dot{\pmb{I}}\pmb{\omega} \\
        &= \pmb{I}\dot{\pmb{\omega}} + \frac{\dif}{\dif t}(\pmb{R}\pmb{I}_{body}\pmb{R}^{T})\pmb{\omega} \\
        &= \pmb{I}\dot{\pmb{\omega}} + (\dot{\pmb{R}}\pmb{I}_{body}\pmb{R}^{T} + \pmb{R}\pmb{I}_{body}\dot{\pmb{R}}^{T})\pmb{\omega} \\
        &= \pmb{I}\dot{\pmb{\omega}} + ([\pmb{\omega}]\pmb{R}\pmb{I}_{body}\pmb{R}^{T} + \pmb{R}\pmb{I}_{body}\pmb{R}^{T} \hat{\pmb{\omega}})\pmb{\omega} \\
        &= \pmb{I}\dot{\pmb{\omega}} + [\pmb{\omega}]\pmb{I}\pmb{\omega} - \pmb{I}[\pmb{\omega}]\pmb{\omega}
    \end{aligned}
    \label{tau_ev}
\end{equation}

Since $\pmb{\omega} \times \pmb{\omega}$ is zero, the final term can be cancels out. This relationship left is knowned as :
\begin{equation}
    \pmb{\tau} = \pmb{I}\dot{\pmb{\omega}} + [\pmb{\omega}]\pmb{I}\pmb{\omega}
\end{equation}


\subsection{Twist/Wrench}
We will now introduce vectors called twists, which describe velocities, and wrenches, which describe forces, and explain how these objects transform from one coordinate frame to another one. 
    \subsubsection{Twist} 
        A twist is a vector that expresses rigid motion or velocity. In Section 2.2, we saw how to parameterize the velocity of a rigid body as a linear velocity vector and an angular velocity vector. The coordinates of a twist are given as a 4-vector in $2$-D simulation, which we can check in \ref{twist}
            \begin{equation}
                \mathbf{v} = \left( \begin{array}{c} \pmb{\omega} \\ \pmb{v} \\ \end{array} \right )
                \label{twist}
            \end{equation}.
        The defination can be found in \ref{twist}, containing a linear velocity vector \(\pmb{v}\) and an angular velocity \(\pmb{\omega}\). According to 

    \subsubsection{Wrench}
        A wrench is a vector that expresses force and torque acting on a body. A wrench can be defined by
        \begin{equation}
            \mathbf{f} = \left( \begin{array}{c} \pmb{\tau} \\ \pmb{f} \\ \end{array} \right ) 
        \end{equation}

        A wrench contains an angular component $\pmb{\tau}$ and a linear component $f$, which are applied at the origin of the coordinate frame they are specified in.


\subsection{Newton-Euler Equation}
    The Newton-Euler equations for a rigid body can now be written in terms of the body's acceleration twist $\mathbf{v}$ methioned in \ref{twist} and the wrench $\mathbf{f}$ metioned in \ref{wrench} acting on the body. We can simply write the Newton and Eular equations,

    \begin{equation}
        \left( \begin{array}{c} \pmb{\tau} - \pmb{\omega} \times \pmb{I} \pmb{\omega}\\ \pmb{f} \end{array}\right) = \left( \begin{array}{cc} \pmb{I} & \pmb{0} \\ \pmb{0}& m\pmb{1}_{2\times 2}\end{array} \right ) \dot{\mathbf{v}}
    \end{equation}
    if we define $\pmb{M}$ and $\pmb{g}$ as Equation \ref{} and \ref{}

    \begin{equation}
        \pmb{M} = \begin{bmatrix}\end{bmatrix}
    \end{equation}


\section{Constrained Dynamics}
    most interesting simulations of rigid bodies involve some kind of constraints. Usually we want to model systems of bodies that are interacting in some way. Some bodies may be in contact with each other, or attached together by some types of joint. Since this report mainly research contact forces, we 
    \subsection{Expressing Constraints as Equations}
        We express constraints mathematically as algebraic matrix equations with position, velocity, or acceleration vectors as the unknowns. In general, the configuration space of a set of n rigid bodies has dimension 6n. Adding constraint equations restricts the position (or velocity, or acceleration) to a subspace of smaller dimension.\\
        The constraints discussed in this thesis will all be holonomic constraints, which means the constraint on the velocity can be found by taking the derivative of a position constraint. Constraints that do not fit this description are called nonholonomic. An example of a nonholonomic constraint is a ball rolling on a table without slipping. The position of the ball has five degrees of freedom, so there is only one degree of constraint (only the height is constrained). Taking the derivative of the position constraint would only give a velocity constraint of degree one. Additional constraints on the velocity are needed to prevent the ball from slipping.\\
        We will describe position constraints with a constraint function $g(\mathbf{p})$, which is a function from the space of possible positions of the rigid bodies, to $\mathbf{R}^d$, where $d$ is the number of degrees of freedom that constraint removes from the dynamic system. If the constraint function returns a zero vector, then the position $\mathbf{p}$ satifies the constraint. \\
        Position constraint can be divided into \slshape{equality constraint}(e.g., joint constraints), where the constraint is $g(\mathbf{p}) = 0$, and \slshape{inequality constraints}(e.g., contact constraints), where $g(\mathbf{p}) \ge 0$. \\
        Constraining the position of an object also constrains its velocity. The velocity constraint function can be found by taking the time derivative of the constraint function. We want the velocity constraint function to be a linear function of the twists representing the velocities of all of the rigid bodies in the system. We let $\pmb{v}$ to be:
        \begin{equation}
            \pmb{v} = \left( \begin{array}{c}\pmb{v}_1 \\ ... \\ \pmb{v}_n \end{array}\right)
        \end{equation}
    \subsection{contact Constraints}
        From other papers \cite{bender2014interactive}, we can conclude some import features of contact constraint:
        \begin{itemize}
            \item Contact forces can push bodies apart, but cannot pull bodies towards each other. This leads to inequalities in the constraint equations.
            \item Contact are transient - they come and go. Contacts can appear suddenly when bodies are moving towards each other, resulting in an impact.
        \end{itemize}
        Impacts between rigid bodies in reality result in large forces applied in over a very short time period, leading to a sudden changes in velocity. There are serveral methods for handling contact in rigid body simulations. Mirtich\cite{mirtich1998rigid} give a summary of serval different methods, and explains the advantages and disadvantages of each. We mainly introduced one  method called .... from Kenny\cite{erleben2017rigid}
        \begin{itemize}
            \item A contract consist of a pair of contact points, one point attached, one point attached to one rigid body, and the other point attached to another rigid body. The contact points are sufficiently close together for our collision detection algorithm to report a collision.
            \item A contact normal is a unit vector that is normal to one or both of the surfaces at the contact points.
            \item The contact constraint Jacobian for constraint $i$, denoted by $\pmb{J}_{c_i}$, is a 1 x 6n matrix, where n is the number of bodies (the subscript `$c$' here stands for `contact').
            \item A contact force $\pmb{J}_{c_i}^{T}\lambda _{c_i}$ is a force acting in the direction of the contact normal which prevents the two rigid bodies from interpenetrating.
            \item The separation distance of a contact is the normal component of the distance between the two contact points. It is negative when the bodies are interpenetrating at the contact. The constraint function $g_{i}(\pmb{p})$ for a contact constraint returns the separation distance. In other words, $g_i \ge 0$.
            \item The relative normal acceleration $a_i$ of a contact is the second derivative of the separation distance with respect to time ($a_i = \ddot{g}_i$). The acceleration constrait is satisfied when $a_i = \pmb{J}_{c_i} \dot{\mathbf{v}}+ k_i \ge 0$
        \end{itemize}
        Let $\pmb{a}$ be a vector containing the relative normal accelerations $\{a_1,...,a_n\}$ for all contacts and $\pmb{\lambda}_c$ be a vector of contact force multipliers$\{\lambda_{c_1},..., \lambda_{c_n}\}$. The vectors $\pmb{a}$ and $\pmb{\lambda}_c$ are linearly related at a given $\mathbf{P}$. Additionally, we have three constraints:
        \begin{enumerate}
            \item The relative normal accelerations must be nongative: $\pmb{a} = \mathcal{J}_c\dot{\mathbf{v}}+k \ge 0$. Since $g$ and $\dot{g}$ are zero, a negative acceleration would cause interpenetration.
            \item The contact force magnitudes must be nonnegative (so as to push the bodies apart): $\pmb{\lambda}_c \ge 0$
            \item For each contact $i$, at least one of $a_i, \lambda_{c_i}$ must be zero, we can write that
            \begin{equation}
                \pmb{a}^{T}\lambda_{c} = 0
            \end{equation}
            Since there can only be a contact force if the bodies are actually touching($g_i\lambda_{c_i} = 0$). Differentiating rh
        \end{enumerate}

        \subsection{}